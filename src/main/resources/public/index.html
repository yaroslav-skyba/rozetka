<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Rozetka</title>

        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
            }

            input {
                padding: 1% 1%;
                border: 1px solid #ccc;
                box-sizing: border-box;
                width: 100%;
            }

            #searchButton, nav {
                background-color: #04AA6D;
                color: white;
                padding: 1% 0;
                margin: 1% 0;
                border: none;
                cursor: pointer;
                width: 100%;
            }

            button:hover {
                opacity: 0.8;
            }

            #logoImg {
                padding-left: 1%;
            }

            #cartImg {
                float: right;
                padding-right: 1%;
            }
        </style>
    </head>

    <body>
        <nav>
            <img src="img/rozetka.jpg" alt="Rozetka" width="50" height="50" id="logoImg">
            <span id="controlSpan"></span>
            <img src="img/cart.jpg" alt="Cart" width="50" height="50" id="cartImg">
        </nav>

        <label for="searchTextInput"><b>Search</b></label>
        <input placeholder="Search products" id="searchTextInput">

        <button id="searchButton">Search</button>

        <div id="productListDiv"></div>

        <script>
            const authority = "http://localhost:8080";
            const tokenKey = "token";
            const xmlHttpRequest = new XMLHttpRequest();
            const controlSpan = document.getElementById("controlSpan");
            const searchTextInput = document.getElementById('searchTextInput');

            onload = function () {
                sendRequest('GET', '/api/v1/products');

                if (localStorage.getItem(tokenKey)) {
                    createControlButton("profile", function () {
                        location.href = "profile.html";
                    }, controlSpan);
                    createControlButton("logout", function () {
                        localStorage.removeItem(tokenKey);
                        location.reload();
                    }, controlSpan);
                } else {
                    createControlButton("login", function () {
                        location.href = "login.html";
                    }, controlSpan);
                    createControlButton("register", function () {
                        location.href = "registration.html";
                    }, controlSpan);
                }
            }

            document.getElementById("logoImg").onclick = function () {
                window.location = authority;
            }

            document.getElementById("searchButton").onclick = function () {
                const value = searchTextInput.value;

                if (value !== "") {
                    sendRequest('GET', '/api/v1/products?name=' + value);
                }
            }

            xmlHttpRequest.onreadystatechange = function () {
                if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200) {
                    if (xmlHttpRequest.responseURL === authority + "/api/v1/products") {
                        displayProductList();
                    } else if (xmlHttpRequest.responseURL === authority + "/api/v1/products?name=" + searchTextInput.value) {
                        document.getElementById("productListDiv").innerHTML = "";
                        displayProductList();
                    }
                }
            }

            function displayProductList() {
                const productListDiv = document.getElementById("productListDiv");
                const productListJson = JSON.parse(xmlHttpRequest.responseText);

                for (let i = 0; i < productListJson.length; i++) {
                    displayProductName(productListJson[i], productListDiv);
                    displayProductField(productListJson[i], "quantity", productListDiv);
                    displayProductField(productListJson[i], "price", productListDiv);
                    displayProductField(productListJson[i], "discount", productListDiv);
                    displayProductField(productListJson[i], "description", productListDiv);

                    productListDiv.appendChild(document.createElement("br"));
                }
            }

            function displayProductName(productJson, productListDiv) {
                const nameProductTN = document.createTextNode(productJson.name);

                const nameProductLink = document.createElement("a");
                nameProductLink.href = "product.html?uuid=" + productJson.uuid;
                nameProductLink.appendChild(nameProductTN);

                const nameProductParagraph = document.createElement("p");
                nameProductParagraph.setAttribute("style", "margin-left: 50%");
                nameProductParagraph.appendChild(nameProductLink);

                productListDiv.appendChild(nameProductParagraph);
            }

            function displayProductField(productJson, productFieldName, productListDiv) {
                let productField;

                if (productJson[productFieldName] == null) {
                    productField = document.createTextNode(productFieldName + ": -");
                } else {
                    productField = document.createTextNode(productFieldName + ": " + productJson[productFieldName]);
                }

                const productFieldParagraph = document.createElement("p");
                productFieldParagraph.setAttribute("style", "margin-left: 50%");
                productFieldParagraph.appendChild(productField);

                productListDiv.appendChild(productFieldParagraph);
            }

            function sendRequest(httpMethod, endpoint) {
                xmlHttpRequest.open(httpMethod, authority + endpoint);
                xmlHttpRequest.send();
            }

            function createControlButton(innerHTML, onclick, controlSpan) {
                const button = document.createElement("button");
                button.innerHTML = innerHTML;
                button.onclick = onclick;

                controlSpan.append(button);
            }
        </script>
    </body>
</html>
